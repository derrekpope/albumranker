<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<title>Album Ranker</title>

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Album Ranker">

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #111;
    color: #fff;
    font-family: system-ui, -apple-system, sans-serif;
}

body {
    display: flex;
    justify-content: center;
    align-items: center;
}

#app {
    width: 100%;
    height: 100%;
    padding: env(safe-area-inset-top) 5vw env(safe-area-inset-bottom);
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

h1, h2 {
    text-align: center;
    margin-bottom: 2vh;
}

input, textarea {
    width: 80%;
    font-size: 3vh;
    padding: 1.5vh;
    margin-bottom: 2vh;
}

button {
    font-size: 3.5vh;
    padding: 2vh 3vw;
    margin: 1vh;
    border-radius: 12px;
    border: none;
}

.rating-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5vh;
    width: 100%;
    max-width: 900px;
    margin-bottom: 3vh;
}

.rating-btn {
    background: #333;
    color: #fff;
}

.rating-btn.selected {
    background: #0a84ff;
    font-weight: bold;
}

.nav-buttons {
    margin-top: 2vh;
}

.hidden {
    display: none;
}
</style>
</head>
<body>

<div id="app">

<!-- STEP 1 -->
<div id="meta-screen">
    <h1>Album Info</h1>
    <input id="artist" placeholder="Artist">
    <input id="album" placeholder="Album">
    <input id="year" placeholder="Year">
    <button onclick="goToSongs()">Next</button>
</div>

<!-- STEP 2 -->
<div id="song-screen" class="hidden">
    <h1>Enter Songs (one per line)</h1>
    <textarea id="songs" rows="10"></textarea>
    <button onclick="startRating()">Start Rating</button>
</div>

<!-- STEP 3 -->
<div id="rate-screen" class="hidden">
    <h2 id="album-title"></h2>
    <h1 id="song-title"></h1>
    <h2 id="current-rating">Current rating: —</h2>

    <div class="rating-grid" id="rating-buttons"></div>

    <div class="nav-buttons">
        <button onclick="prevSong()">Previous</button>
        <button onclick="nextSong()">Next</button>
        <button onclick="exportCSV()">Export CSV</button>
    </div>
</div>

</div>

<script>
let artist, album, year;
let songList = [];
let ratings = {};
let index = 0;

const ratingValues = [6,5,4,3,2,1,0,-1,-2,"S"];

function goToSongs() {
    artist = artistInput().value;
    album = albumInput().value;
    year = yearInput().value;

    toggle("meta-screen", false);
    toggle("song-screen", true);
}

function startRating() {
    songList = songsInput().value.split("\n").map(s => s.trim()).filter(Boolean);
    songList.forEach(s => ratings[s] = null);

    document.getElementById("album-title").innerText = `${artist} — ${album}`;
    buildButtons();

    toggle("song-screen", false);
    toggle("rate-screen", true);
    showSong();
}

function buildButtons() {
    const grid = document.getElementById("rating-buttons");
    grid.innerHTML = "";

    ratingValues.forEach(v => {
        const b = document.createElement("button");
        b.innerText = v;
        b.className = "rating-btn";
        b.onclick = () => setRating(v);
        grid.appendChild(b);
    });
}

function setRating(value) {
    ratings[songList[index]] = value;
    updateRatingUI();
}

function showSong() {
    document.getElementById("song-title").innerText = songList[index];
    updateRatingUI();
}

function updateRatingUI() {
    const current = ratings[songList[index]];
    document.getElementById("current-rating").innerText =
        `Current rating: ${current !== null ? current : "—"}`;

    document.querySelectorAll(".rating-btn").forEach(btn => {
        btn.classList.toggle("selected", btn.innerText == current);
    });
}

function nextSong() {
    if (index < songList.length - 1) {
        index++;
        showSong();
    }
}

function prevSong() {
    if (index > 0) {
        index--;
        showSong();
    }
}

function exportCSV() {
    const cols = {
        6: "C", 5: "C", 4: "D", 3: "E", 2: "F",
        1: "G", 0: "H", "-1": "I", "-2": "J", "S": "K"
    };

    let csv = [];
    csv[0] = artist;
    csv[1] = `${year},${album}`;

    let row = 2;
    const ordered = [6,5,4,3,2,1,0,-1,-2,"S"];

    ordered.forEach(r => {
        songList.forEach(s => {
            if (ratings[s] === r) {
                const col = cols[r];
                csv[row] = `${",".repeat(colIndex(col))}${s}`;
                row++;
            }
        });
    });

    const valid = songList.map(s => ratings[s]).filter(v => typeof v === "number");
    const total = valid.length;
    const avg = total ? (valid.reduce((a,b)=>a+b,0) / total).toFixed(9) : "0.000000000";

    csv[row + 1] = `${",".repeat(11)}${total},${avg}`;

    download(csv.join("\n"), `${artist} - ${album}.csv`);
}

function colIndex(c) {
    return c.charCodeAt(0) - 65;
}

function download(text, name) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([text], {type: "text/csv"}));
    a.download = name;
    a.click();
}

function toggle(id, show) {
    document.getElementById(id).classList.toggle("hidden", !show);
}

const artistInput = () => document.getElementById("artist");
const albumInput = () => document.getElementById("album");
const yearInput = () => document.getElementById("year");
const songsInput = () => document.getElementById("songs");
</script>

</body>
</html>
