<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<title>Album Ranker</title>

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Album Ranker">

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #111;
    color: #fff;
    font-family: system-ui, -apple-system, sans-serif;
}

body {
    display: flex;
    justify-content: center;
    align-items: center;
}

#app {
    width: 100%;
    height: 100%;
    padding: env(safe-area-inset-top) 5vw env(safe-area-inset-bottom);
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

h1, h2 {
    margin-bottom: 2vh;
    text-align: center;
}

input, textarea {
    width: 80%;
    font-size: 2.5vh;
    padding: 1vh;
    margin-bottom: 2vh;
}

button {
    font-size: 3vh;
    padding: 2vh 3vw;
    margin: 1vh;
}

.rating-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1vh;
    width: 100%;
    max-width: 900px;
}

.top-bar {
    position: fixed;
    top: env(safe-area-inset-top);
    right: 2vw;
    z-index: 10;
}

.close-btn {
    background: #900;
    color: #fff;
    border: none;
    font-size: 3vh;
    padding: 1vh 2vw;
    border-radius: 8px;
}

.hidden {
    display: none;
}
</style>
</head>
<body>

<div class="top-bar">
    <button class="close-btn" onclick="window.close()">✕</button>
</div>

<div id="app">

<!-- STEP 1 -->
<div id="meta-screen">
    <h1>Album Info</h1>
    <input id="artist" placeholder="Artist">
    <input id="album" placeholder="Album">
    <input id="year" placeholder="Year">
    <button onclick="goToSongs()">Next</button>
</div>

<!-- STEP 2 -->
<div id="song-screen" class="hidden">
    <h1>Enter Songs (one per line)</h1>
    <textarea id="songs" rows="10"></textarea>
    <button onclick="startRating()">Start Rating</button>
</div>

<!-- STEP 3 -->
<div id="rate-screen" class="hidden">
    <h2 id="album-title"></h2>
    <h1 id="song-title"></h1>

    <div class="rating-grid" id="rating-buttons"></div>

    <div>
        <button onclick="prevSong()">Previous</button>
        <button onclick="nextSong()">Next</button>
        <button onclick="exportCSV()">Export CSV</button>
    </div>
</div>

</div>

<script>
let artist, album, year;
let songList = [];
let ratings = {};
let index = 0;

const ratingValues = [6,5,4,3,2,1,0,-1,-2,"S"];

function goToSongs() {
    artist = artistInput().value;
    album = albumInput().value;
    year = yearInput().value;

    toggle("meta-screen", false);
    toggle("song-screen", true);
}

function startRating() {
    songList = songsInput().value.split("\n").map(s => s.trim()).filter(Boolean);
    songList.forEach(s => ratings[s] = null);

    document.getElementById("album-title").innerText = `${artist} — ${album}`;
    buildButtons();

    toggle("song-screen", false);
    toggle("rate-screen", true);
    showSong();
}

function buildButtons() {
    const grid = document.getElementById("rating-buttons");
    grid.innerHTML = "";
    ratingValues.forEach(v => {
        const b = document.createElement("button");
        b.innerText = v;
        b.onclick = () => { ratings[songList[index]] = v; };
        grid.appendChild(b);
    });
}

function showSong() {
    document.getElementById("song-title").innerText = songList[index];
}

function nextSong() {
    if (index < songList.length - 1) index++;
    showSong();
}

function prevSong() {
    if (index > 0) index--;
    showSong();
}

function exportCSV() {
    const cols = {
        6: "C", 5: "C", 4: "D", 3: "E", 2: "F",
        1: "G", 0: "H", "-1": "I", "-2": "J", "S": "K"
    };

    let rows = [];
    let row = 3;

    const ordered = ratingValues.slice().filter(v => v !== "S");

    ordered.forEach(r => {
        songList.forEach(s => {
            if (ratings[s] === r) {
                rows.push({row, col: cols[r], song: s, underline: r === 6});
                row++;
            }
        });
    });

    songList.forEach(s => {
        if (ratings[s] === "S") {
            rows.push({row, col: "K", song: s});
            row++;
        }
    });

    let csv = [];
    csv.push(`${artist}`);
    csv.push(`,${album}`);
    csv[1] = `${year},${album}`;

    rows.forEach(r => {
        csv[r.row - 1] = `${",".repeat(colIndex(r.col))}${r.song}`;
    });

    const validRatings = songList
        .map(s => ratings[s])
        .filter(v => typeof v === "number");

    const total = validRatings.length;
    const avg = total ? (validRatings.reduce((a,b)=>a+b,0) / total).toFixed(9) : "0.000000000";

    csv.push("");
    csv.push(`${",".repeat(11)}${total},${avg}`);

    download(csv.join("\n"), `${artist} - ${album}.csv`);
}

function colIndex(c) {
    return c.charCodeAt(0) - 65;
}

function download(text, name) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([text], {type: "text/csv"}));
    a.download = name;
    a.click();
}

function toggle(id, show) {
    document.getElementById(id).classList.toggle("hidden", !show);
}

const artistInput = () => document.getElementById("artist");
const albumInput = () => document.getElementById("album");
const yearInput = () => document.getElementById("year");
const songsInput = () => document.getElementById("songs");
</script>

</body>
</html>
